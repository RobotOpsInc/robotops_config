name: Release

on:
  workflow_dispatch:
    # Manual trigger only - production releases from main branch only
    inputs:
      dry_run:
        description: 'Dry run (validate without creating release)'
        type: boolean
        default: false

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Needed to create releases and tags
    steps:
      - uses: actions/checkout@v4

      - name: Ensure release is from main branch
        run: |
          if [ "${{ github.ref }}" != "refs/heads/main" ]; then
            echo "::error::Production releases can only be created from the main branch"
            echo "Current branch: ${{ github.ref }}"
            echo "Use the 'Development Release' workflow for pre-releases from other branches"
            exit 1
          fi

      - name: Get version from VERSION file
        id: version
        run: |
          VERSION=$(cat VERSION)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT

      - name: Check tag doesn't already exist
        run: |
          if git ls-remote --tags origin | grep -q "refs/tags/${{ steps.version.outputs.tag }}$"; then
            echo "::error::Tag ${{ steps.version.outputs.tag }} already exists"
            exit 1
          fi

      - name: Extract changelog for this version
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Extract section between "## [VERSION]" and the next "## [" or end of file
          CHANGELOG=$(awk -v ver="$VERSION" '
            /^## \[/ {
              if (found) exit
              if ($0 ~ "\\[" ver "\\]") found=1
            }
            found { print }
          ' CHANGELOG.md)

          # Write to file for gh release
          echo "$CHANGELOG" > release_notes.md

          echo "Extracted changelog:"
          cat release_notes.md

      - name: Create GitHub Release
        if: ${{ !inputs.dry_run }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create "${{ steps.version.outputs.tag }}" \
            --title "Release ${{ steps.version.outputs.tag }}" \
            --notes-file release_notes.md

      - name: Dry run summary
        if: ${{ inputs.dry_run }}
        run: |
          echo "## Dry Run Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Would create release:" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** ${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Title:** Release ${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Release Notes" >> $GITHUB_STEP_SUMMARY
          cat release_notes.md >> $GITHUB_STEP_SUMMARY

  publish-packages:
    strategy:
      matrix:
        include:
          - arch: amd64
            conan_arch: x86_64
            runner: ubuntu-latest
          - arch: arm64
            conan_arch: armv8
            runner: ubuntu-24.04-arm
    runs-on: ${{ matrix.runner }}
    needs: release
    if: ${{ !inputs.dry_run }}
    permissions:
      contents: write  # Needed to upload release assets
    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          VERSION=$(cat VERSION)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT

      - name: Set up Buf
        uses: bufbuild/buf-setup-action@v1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install protoc
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler

      - name: Install just
        uses: extractions/setup-just@v2

      - name: Generate code
        run: just generate

      - name: Upload YAML config as release asset
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Upload YAML file to GitHub release with user-friendly name
          gh release upload "${{ steps.version.outputs.tag }}" \
            generated/yaml/default.yaml#config.yaml \
            --clobber

          echo "✅ Uploaded config.yaml to release ${{ steps.version.outputs.tag }}"
          echo ""
          echo "Public download URL:"
          echo "https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/config.yaml"

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Publish Rust crate to Cloudsmith
        if: ${{ matrix.arch == 'amd64' }}
        env:
          CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
        run: |
          cd generated/sdks/rust

          # Configure Cloudsmith as a cargo registry
          mkdir -p ~/.cargo
          cat >> ~/.cargo/config.toml <<EOF
          [registries.cloudsmith]
          index = "sparse+https://cargo.cloudsmith.io/robotops/robotops-config-rust/"
          token = "Token ${CLOUDSMITH_API_KEY}"
          credential-provider = "cargo:token"
          EOF

          # Publish to Cloudsmith
          cargo publish --registry cloudsmith --allow-dirty

      - name: Install Conan
        run: |
          pip3 install conan

      - name: Set up Conan profile
        run: |
          conan profile detect --force

      - name: Publish C++ package to Cloudsmith
        env:
          CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
          CONAN_USER: github-actions-bk1d
        run: |
          cd generated/sdks/cpp

          # Configure Cloudsmith remote
          conan remote add robotops-robotops-config-cpp https://conan.cloudsmith.io/robotops/robotops-config-cpp/ || true
          conan remote login -p "${CLOUDSMITH_API_KEY}" robotops-robotops-config-cpp "${CONAN_USER}"

          # Create and upload package (arch-specific build)
          conan create . --version=${{ steps.version.outputs.version }} -s arch=${{ matrix.conan_arch }} --build=missing
          conan upload "robotops-config/${{ steps.version.outputs.version }}" --confirm -r robotops-robotops-config-cpp

      - name: Summary
        run: |
          echo "## Package Publishing (${{ matrix.arch }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Version: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "Architecture: ${{ matrix.arch }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Published Packages" >> $GITHUB_STEP_SUMMARY
          echo "✅ Rust crate: https://cloudsmith.io/~robotopsinc/repos/robotops-config-rust/packages/" >> $GITHUB_STEP_SUMMARY
          echo "✅ C++ package (${{ matrix.arch }}): https://cloudsmith.io/~robotopsinc/repos/robotops-config-cpp/packages/" >> $GITHUB_STEP_SUMMARY
          echo "✅ YAML config: https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/config.yaml" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Usage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Rust:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`toml" >> $GITHUB_STEP_SUMMARY
          echo "[dependencies]" >> $GITHUB_STEP_SUMMARY
          echo "robotops-config = { version = \"${{ steps.version.outputs.version }}\", registry = \"cloudsmith\" }" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**C++:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "conan install --requires=robotops-config/${{ steps.version.outputs.version }}@" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**YAML Config:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Download versioned configuration" >> $GITHUB_STEP_SUMMARY
          echo "curl -L -o config.yaml https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/config.yaml" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
