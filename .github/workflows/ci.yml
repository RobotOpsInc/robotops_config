name: CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  proto-lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install just
        run: |
          curl -sSL https://github.com/casey/just/releases/download/1.36.0/just-1.36.0-x86_64-unknown-linux-musl.tar.gz | tar xz -C /tmp just
          sudo mv /tmp/just /usr/local/bin/

      - name: Buf lint and breaking checks
        run: just lint

      - name: Buf breaking (check against base branch)
        if: github.event_name == 'pull_request'
        run: |
          # Check against the PR's base branch (e.g., main or development)
          BASE_BRANCH="${{ github.base_ref }}"
          echo "Checking for breaking changes against branch: $BASE_BRANCH"

          # Try to check against base branch using Docker (lint step already built the image)
          set +e
          OUTPUT=$(docker run --rm -v $(pwd):/ws/src/robotops-config robotops-config:build bash -c "cd /ws/src/robotops-config && buf breaking proto --against \"https://github.com/${{ github.repository }}.git#branch=$BASE_BRANCH,subdir=proto\" 2>&1")
          EXIT_CODE=$?
          set -e

          if echo "$OUTPUT" | grep -q "had no .proto files"; then
            echo "ℹ️  Base branch $BASE_BRANCH has no proto files yet - skipping breaking change check"
            echo "This is expected for the first PR adding proto files to this branch"
            exit 0
          elif echo "$OUTPUT" | grep -q "has an invalid"; then
            echo "⚠️  Base branch has incompatible buf.yaml version - skipping breaking change check"
            echo "This is expected when base branch uses different buf version"
            exit 0
          elif [ $EXIT_CODE -ne 0 ]; then
            echo "$OUTPUT"
            exit $EXIT_CODE
          else
            echo "✅ No breaking changes detected against $BASE_BRANCH"
          fi

  proto-generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install just
        run: |
          curl -sSL https://github.com/casey/just/releases/download/1.36.0/just-1.36.0-x86_64-unknown-linux-musl.tar.gz | tar xz -C /tmp just
          sudo mv /tmp/just /usr/local/bin/

      - name: Generate code
        run: just generate

  test-rust-package:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install just
        run: |
          curl -sSL https://github.com/casey/just/releases/download/1.36.0/just-1.36.0-x86_64-unknown-linux-musl.tar.gz | tar xz -C /tmp just
          sudo mv /tmp/just /usr/local/bin/

      - name: Generate code
        run: just generate

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Check Rust package
        run: |
          cargo check --manifest-path generated/sdks/rust/Cargo.toml --all-targets
          cargo clippy --manifest-path generated/sdks/rust/Cargo.toml -- -D warnings

  test-cpp-package:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install just
        run: |
          curl -sSL https://github.com/casey/just/releases/download/1.36.0/just-1.36.0-x86_64-unknown-linux-musl.tar.gz | tar xz -C /tmp just
          sudo mv /tmp/just /usr/local/bin/

      - name: Generate code
        run: just generate

      - name: Install build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y libprotobuf-dev

      - name: Validate C++ headers compile
        run: |
          cd generated/sdks/cpp
          # Basic compilation test for generated headers
          g++ -c -std=c++17 -I. -I/usr/include proto/robotops/config/v1/config.pb.cc -o /tmp/config.pb.o
          echo "C++ package validated successfully"

  test-ros2-package-integration:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Install just
        run: |
          curl -sSL https://github.com/casey/just/releases/download/1.36.0/just-1.36.0-x86_64-unknown-linux-musl.tar.gz | tar xz -C /tmp just
          sudo mv /tmp/just /usr/local/bin/

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true
          tags: robotops-config:build
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Generate protobuf code
        run: just generate

      - name: Build Debian package
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/ws/src/robotops-config \
            -v ${{ github.workspace }}:/output \
            robotops-config:build bash -c "
              cd /ws/src/robotops-config && \
              cp generated/ros2/package.xml . && \
              cp generated/ros2/CMakeLists.txt . && \
              mkdir -p cmake && cp generated/ros2/robotops-configConfig.cmake.in cmake/ && \
              apt-get update && \
              apt-get install -y dpkg-dev fakeroot debhelper && \
              bloom-generate rosdebian --os-name ubuntu --os-version noble --ros-distro jazzy && \
              dpkg-buildpackage -us -uc -b && \
              cp /ws/src/*.deb /output/
            "

      - name: Find built package
        id: deb
        run: |
          DEB_FILE=$(ls *.deb | head -n1)
          echo "file=$DEB_FILE" >> $GITHUB_OUTPUT
          echo "Built package: $DEB_FILE"

      - name: Validate package CMake integration
        run: |
          echo "Installing package for validation..."
          sudo dpkg -i ${{ steps.deb.outputs.file }} || sudo apt-get install -f -y

          echo "Installing build dependencies for integration test..."
          sudo apt-get install -y libprotobuf-dev

          echo "Running CMake integration tests..."
          cd test/cmake_integration
          mkdir -p build && cd build

          # Configure with ROS2 prefix
          cmake .. -DCMAKE_PREFIX_PATH=/opt/ros/jazzy

          # Build the test
          cmake --build .

          # Run the test executable
          ./test_robotops_config

          echo "✅ All CMake integration tests passed"

      - name: Check installed files
        run: |
          echo "Verifying installation..."

          # Verify library exists
          test -f /opt/ros/jazzy/lib/librobotops-config.so || \
            { echo "❌ Library not found"; exit 1; }
          echo "✓ Library found"

          # Verify headers exist
          test -f /opt/ros/jazzy/include/robotops/config/v1/config.pb.h || \
            { echo "❌ Headers not found"; exit 1; }
          echo "✓ Headers found"

          # Verify CMake config exists (ament location)
          test -f /opt/ros/jazzy/share/robotops-config/cmake/robotops-configConfig.cmake || \
            { echo "❌ CMake config not found"; exit 1; }
          echo "✓ CMake config found"

          # Check library links to protobuf
          ldd /opt/ros/jazzy/lib/librobotops-config.so | grep protobuf || \
            { echo "❌ Protobuf not linked"; exit 1; }
          echo "✓ Protobuf linked correctly"

          echo "✅ All file checks passed"

  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install just
        run: |
          curl -sSL https://github.com/casey/just/releases/download/1.36.0/just-1.36.0-x86_64-unknown-linux-musl.tar.gz | tar xz -C /tmp just
          sudo mv /tmp/just /usr/local/bin/

      - name: Generate code
        run: just generate

      - name: Run validation
        run: just validate

  version-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need history for diff

      - name: Install just
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin

      - name: Validate schema_versions match VERSION file
        run: just validate-versions

      - name: Check if version bump required
        if: github.event_name == 'pull_request'
        run: |
          # Files that require a version bump when changed
          VERSIONED_PATTERNS="proto/*.proto .yamllint"

          # Get changed files in this PR
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          echo "Changed files:"
          echo "$CHANGED_FILES"
          echo ""

          # Check if any versioned file changed
          VERSIONED_CHANGED=false
          for file in $CHANGED_FILES; do
            case "$file" in
              proto/*.proto|.yamllint)
                VERSIONED_CHANGED=true
                echo "Versioned file changed: $file"
                ;;
            esac
          done

          if [ "$VERSIONED_CHANGED" = "true" ]; then
            echo ""
            echo "Versioned files changed - checking if VERSION was bumped..."

            if echo "$CHANGED_FILES" | grep -q "^VERSION$"; then
              echo "VERSION file was updated. Checking if it was actually bumped..."

              OLD_VERSION=$(git show origin/${{ github.base_ref }}:VERSION 2>/dev/null || echo "0.0.0")
              NEW_VERSION=$(cat VERSION)

              if [ "$OLD_VERSION" = "$NEW_VERSION" ]; then
                echo "::error::VERSION file changed but version was not bumped (still $NEW_VERSION)"
                exit 1
              else
                echo "Version bumped: $OLD_VERSION -> $NEW_VERSION"
              fi
            else
              echo "::error::Versioned files changed but VERSION file was not updated. Run 'just bump-version patch|minor|major'"
              exit 1
            fi
          else
            echo "No versioned files changed - version bump not required"
          fi

      - name: Check CHANGELOG has entry for version
        if: github.event_name == 'pull_request'
        run: |
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          # Only check if VERSION was changed
          if echo "$CHANGED_FILES" | grep -q "^VERSION$"; then
            VERSION=$(cat VERSION)
            echo "Checking CHANGELOG.md for version $VERSION entry..."

            # Look for a header like "## [0.1.2]" or "## [0.1.2] - 2026-01-07"
            if grep -qE "^## \[$VERSION\]" CHANGELOG.md; then
              echo "CHANGELOG.md has entry for version $VERSION"
            else
              echo "::error::VERSION was bumped to $VERSION but CHANGELOG.md is missing an entry."
              echo "::error::Add a section: ## [$VERSION] - $(date +%Y-%m-%d)"
              exit 1
            fi
          else
            echo "VERSION not changed - skipping CHANGELOG check"
          fi
