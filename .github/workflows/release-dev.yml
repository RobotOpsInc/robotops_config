name: Development Release

on:
  workflow_dispatch:
    # Manual trigger only - must be run from development branch

jobs:
  release-dev:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Needed to create releases and tags
    steps:
      - uses: actions/checkout@v4

      - name: Ensure release is from development branch
        run: |
          if [ "${{ github.ref }}" != "refs/heads/development" ]; then
            echo "::error::Development releases can only be created from the development branch"
            echo "Current branch: ${{ github.ref }}"
            echo "For production releases from main, use the 'Release' workflow"
            exit 1
          fi

      - name: Generate dev version
        id: version
        run: |
          BASE_VERSION=$(cat VERSION)
          SHORT_SHA=$(git rev-parse --short HEAD)
          DEV_VERSION="${BASE_VERSION}-development-${SHORT_SHA}"

          echo "version=$DEV_VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$DEV_VERSION" >> $GITHUB_OUTPUT
          echo "base_version=$BASE_VERSION" >> $GITHUB_OUTPUT

          echo "Generated dev version: $DEV_VERSION"

      - name: Check if tag already exists
        id: check_tag
        run: |
          if git ls-remote --tags origin | grep -q "refs/tags/${{ steps.version.outputs.tag }}$"; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Tag ${{ steps.version.outputs.tag }} already exists - will update pre-release"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Delete existing pre-release if exists
        if: steps.check_tag.outputs.exists == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release delete "${{ steps.version.outputs.tag }}" --yes || true
          git push --delete origin "${{ steps.version.outputs.tag }}" || true

      - name: Create GitHub Pre-Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          cat > release_notes.md <<EOF
          ## Development Release

          **Base Version:** ${{ steps.version.outputs.base_version }}
          **Commit:** \`${GITHUB_SHA}\`
          **Branch:** \`development\`

          This is an automated pre-release build from the development branch for testing purposes.

          ### ⚠️ Not for Production Use

          This release is intended for development and testing only. For production deployments, use stable releases from the main branch.

          ### Usage

          **Rust:**
          \`\`\`toml
          [dependencies]
          robotops-config = { version = "${{ steps.version.outputs.version }}", registry = "cloudsmith-dev" }
          \`\`\`

          **C++:**
          \`\`\`bash
          conan install --requires=robotops-config/${{ steps.version.outputs.version }}@
          \`\`\`

          **YAML Config:**
          \`\`\`bash
          curl -L -o config.yaml \\
            https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/config.yaml
          \`\`\`
          EOF

          gh release create "${{ steps.version.outputs.tag }}" \
            --title "Development Release ${{ steps.version.outputs.tag }}" \
            --notes-file release_notes.md \
            --prerelease

  publish-dev-packages:
    runs-on: ubuntu-latest
    needs: release-dev
    permissions:
      contents: write  # Needed to upload release assets
    steps:
      - uses: actions/checkout@v4

      - name: Generate dev version
        id: version
        run: |
          BASE_VERSION=$(cat VERSION)
          SHORT_SHA=$(git rev-parse --short HEAD)
          DEV_VERSION="${BASE_VERSION}-development-${SHORT_SHA}"

          echo "version=$DEV_VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$DEV_VERSION" >> $GITHUB_OUTPUT

      - name: Set up Buf
        uses: bufbuild/buf-setup-action@v1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install protoc
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler

      - name: Install just
        uses: extractions/setup-just@v2

      - name: Generate code
        run: just generate

      - name: Upload YAML config as pre-release asset
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Upload YAML file to GitHub pre-release with user-friendly name
          gh release upload "${{ steps.version.outputs.tag }}" \
            generated/yaml/default.yaml#config.yaml \
            --clobber

          echo "✅ Uploaded config.yaml to pre-release ${{ steps.version.outputs.tag }}"
          echo ""
          echo "Public download URL:"
          echo "https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/config.yaml"

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Update Rust package version
        run: |
          cd generated/sdks/rust
          # Update version in Cargo.toml
          sed -i 's/version = ".*"/version = "${{ steps.version.outputs.version }}"/' Cargo.toml

      - name: Publish Rust crate to Cloudsmith (dev)
        env:
          CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
        run: |
          cd generated/sdks/rust

          # Configure Cloudsmith dev registry
          mkdir -p ~/.cargo
          cat >> ~/.cargo/config.toml <<EOF
          [registries.cloudsmith-dev]
          index = "sparse+https://cargo.cloudsmith.io/robotops/robotops-config-rust-dev/"
          token = "Token ${CLOUDSMITH_API_KEY}"
          credential-provider = "cargo:token"
          EOF

          # Publish to Cloudsmith dev registry
          cargo publish --registry cloudsmith-dev --allow-dirty

      - name: Install Conan
        run: |
          pip3 install conan

      - name: Set up Conan profile
        run: |
          conan profile detect --force

      - name: Update C++ package version
        run: |
          cd generated/sdks/cpp
          # Update version in conanfile.py
          sed -i 's/version = ".*"/version = "${{ steps.version.outputs.version }}"/' conanfile.py

      - name: Publish C++ package to Cloudsmith (dev)
        env:
          CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
          CONAN_USER: github-actions-bk1d
        run: |
          cd generated/sdks/cpp

          # Configure Cloudsmith dev remote
          conan remote add robotops-robotops-config-cpp-dev https://conan.cloudsmith.io/robotops/robotops-config-cpp-dev/ || true
          conan remote login -p "${CLOUDSMITH_API_KEY}" robotops-robotops-config-cpp-dev "${CONAN_USER}"

          # Create and upload package
          conan create . --version=${{ steps.version.outputs.version }} --user="${CONAN_USER}" --channel=_
          conan upload "robotops-config/${{ steps.version.outputs.version }}@${CONAN_USER}/_" --confirm -r robotops-robotops-config-cpp-dev

      - name: Summary
        run: |
          echo "## Development Package Publishing" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${GITHUB_SHA}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ⚠️ Development Packages Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "These packages are for **testing only** and should not be used in production." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Rust crate: https://cloudsmith.io/~robotopsinc/repos/robotops-config-rust-dev/packages/" >> $GITHUB_STEP_SUMMARY
          echo "✅ C++ package: https://cloudsmith.io/~robotopsinc/repos/robotops-config-cpp-dev/packages/" >> $GITHUB_STEP_SUMMARY
          echo "✅ YAML config: https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/config.yaml" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Usage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Rust:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`toml" >> $GITHUB_STEP_SUMMARY
          echo "[registries.cloudsmith-dev]" >> $GITHUB_STEP_SUMMARY
          echo "index = \"sparse+https://dl.cloudsmith.io/basic/robotopsinc/robotops-config-rust-dev/cargo/index.git\"" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[dependencies]" >> $GITHUB_STEP_SUMMARY
          echo "robotops-config = { version = \"${{ steps.version.outputs.version }}\", registry = \"cloudsmith-dev\" }" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**C++:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "conan remote add cloudsmith-dev https://api.cloudsmith.io/conan/robotopsinc/robotops-config-cpp-dev/" >> $GITHUB_STEP_SUMMARY
          echo "conan install --requires=robotops-config/${{ steps.version.outputs.version }}@" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**YAML Config:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Download development configuration" >> $GITHUB_STEP_SUMMARY
          echo "curl -L -o config.yaml https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/config.yaml" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
